# ESP32 + LDR Setup Instructions

## ğŸ”Œ Hardware Wiring

### LDR (Light Sensor) Connection

```
Components needed:
- ESP32 Development Board
- LDR (Light Dependent Resistor)
- 10kÎ© Resistor
- Breadboard
- Jumper wires
```

### Wiring Diagram:

```
        3.3V
         |
         |
        LDR
         |
         |-------- GPIO34 (ADC1_CH6)
         |
       10kÎ©
    Resistor
         |
        GND
```

### Step-by-Step Connections:

1. **LDR First Terminal** â†’ **3.3V** on ESP32
2. **LDR Second Terminal** â†’ **GPIO34** (analog pin) AND one side of 10kÎ© resistor
3. **10kÎ© Resistor (other side)** â†’ **GND** on ESP32

**Why the resistor?**
The 10kÎ© resistor creates a voltage divider with the LDR. As light changes, the resistance of the LDR changes, which changes the voltage at GPIO34 that the ESP32 can read.

---

## ğŸ’» Software Setup

### Step 1: Install Arduino IDE

1. Download from: https://www.arduino.cc/en/software
2. Install for your operating system

### Step 2: Add ESP32 Board Support

1. Open Arduino IDE
2. Go to **File â†’ Preferences**
3. In "Additional Board Manager URLs", add:
   ```
   https://dl.espressif.com/dl/package_esp32_index.json
   ```
4. Click OK
5. Go to **Tools â†’ Board â†’ Boards Manager**
6. Search for "esp32"
7. Install "**esp32 by Espressif Systems**"

### Step 3: Install Required Libraries

1. Go to **Sketch â†’ Include Library â†’ Manage Libraries**
2. Search and install:
   - **ArduinoJson** by Benoit Blanchon (version 6.x or later)

### Step 4: Select ESP32 Board

1. Go to **Tools â†’ Board â†’ ESP32 Arduino**
2. Select your ESP32 model (e.g., "ESP32 Dev Module")
3. Go to **Tools â†’ Port**
4. Select the COM port where your ESP32 is connected

---

## âš™ï¸ Backend Setup

### Step 1: Create Bot User

You need to create a user account for the ESP32 to authenticate with.

**Option A: Use existing login credentials**
- Login to your app with your account
- Go to profile settings (future feature)
- Or use your current account email/password

**Option B: Create via database**

If you have access to your database, run this SQL:

```sql
-- First, hash the password (use bcrypt)
-- For password 'esp32secure123', the hash would be generated by your backend

-- Then insert the user
INSERT INTO "User" (email, password, name, role, "createdAt", "updatedAt")
VALUES (
  'esp32bot@synciot.com',
  '$2a$10$[HASHED_PASSWORD_HERE]',  -- Replace with actual bcrypt hash
  'ESP32 Bot',
  'operator',
  NOW(),
  NOW()
);
```

**Option C: Use Signup API**

Use Postman or curl to create the user:

```bash
curl -X POST https://synciot-backend.vercel.app/api/auth/signup \
  -H "Content-Type: application/json" \
  -d '{
    "email": "esp32bot@synciot.com",
    "password": "esp32secure123",
    "name": "ESP32 Bot"
  }'
```

### Step 2: Deploy Backend Changes

The bulk sensor endpoint has been added to your backend. You need to deploy it:

```bash
cd backend
git add .
git commit -m "feat: Add bulk sensor update endpoint for ESP32"
git push
```

Vercel will automatically deploy the changes.

---

## ğŸ“ Configure ESP32 Code

1. Open `esp32_iot_client.ino` in Arduino IDE
2. Open the `config.h` tab
3. Update the following:

```cpp
// WiFi Credentials
#define WIFI_SSID "YourWiFiName"          // Your WiFi network name
#define WIFI_PASSWORD "YourWiFiPassword"  // Your WiFi password

// API Configuration
#define API_BASE_URL "https://synciot-backend.vercel.app/api"

// Robot Configuration
#define ROBOT_ID 1  // Get this from your dashboard - check robot ID

// Bot Authentication
#define BOT_EMAIL "esp32bot@synciot.com"
#define BOT_PASSWORD "esp32secure123"
```

### Important Notes:

- **WiFi SSID**: Must be exactly as shown on your router (case-sensitive)
- **WiFi Password**: Your WiFi password (case-sensitive)
- **ROBOT_ID**: Check your dashboard to see what ID your robot has
- **API_BASE_URL**: For local testing use `http://[YOUR_COMPUTER_IP]:3001/api`

---

## ğŸš€ Upload and Test

### Step 1: Connect ESP32

1. Connect ESP32 to computer via USB cable
2. Wait for drivers to install (first time only)

### Step 2: Upload Code

1. In Arduino IDE, click **Verify** (âœ“) to compile
2. If no errors, click **Upload** (â†’)
3. Wait for "Done uploading" message

### Step 3: Open Serial Monitor

1. Go to **Tools â†’ Serial Monitor**
2. Set baud rate to **115200** (bottom right)
3. You should see output like:

```
=====================================
  ESP32 IoT Client Starting
=====================================

ğŸ“¡ LDR sensor initialized on pin 34
ğŸ“¡ Connecting to WiFi: YourWiFiName
....
âœ… WiFi connected!
ğŸ“ IP Address: 192.168.1.105
ğŸ“¶ Signal Strength: -45 dBm

ğŸ” Authenticating with backend...
POST https://synciot-backend.vercel.app/api/auth/login
âœ… Authentication successful!
ğŸ« Token received and stored

===== Initialization Complete =====
Starting sensor data transmission...

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â±ï¸  Time: 5s

ğŸ“Š Reading sensors...
  ğŸ’¡ Light Level: Bright
  ğŸ”† Light (Lux): 752.3 lux
  ğŸ“ˆ Light (%): 65.2%
  ğŸ”¢ Raw ADC: 2667
  ğŸ”‹ Battery: 87%
  ğŸ“¶ WiFi Signal: -52 dBm

ğŸš€ Sending data to backend...
POST https://synciot-backend.vercel.app/api/robots/1/sensors/bulk
ğŸ“¥ Response Code: 200
âœ… Data sent successfully!
ğŸ“Š Updated 3 sensors
```

---

## ğŸ› Troubleshooting

### Issue: "WiFi connection timeout"

**Solutions:**
- Check WIFI_SSID is exactly correct (case-sensitive)
- Check WIFI_PASSWORD is correct
- Ensure you're using 2.4GHz WiFi (ESP32 doesn't support 5GHz)
- Move ESP32 closer to router
- Restart router

### Issue: "Authentication failed! HTTP 401"

**Solutions:**
- Check BOT_EMAIL and BOT_PASSWORD match the user in database
- Verify the bot user was created successfully
- Check backend is running (visit API_BASE_URL in browser)
- Try creating the user again via signup API

### Issue: "Robot not found! Check ROBOT_ID"

**Solutions:**
- Login to your dashboard
- Check the robot ID in the URL (e.g., /robot/1 â†’ ID is 1)
- Update ROBOT_ID in config.h to match
- Or create a new robot in the dashboard first

### Issue: "Compilation errors"

**Solutions:**
- Ensure ArduinoJson library is installed
- Check ESP32 board package is installed
- Select correct board: ESP32 Dev Module
- Update Arduino IDE to latest version

### Issue: LDR reads constant values

**Solutions:**
- Check wiring - LDR to 3.3V, GPIO34, and GND via resistor
- Try adjusting LDR_MIN_VALUE and LDR_MAX_VALUE in config.h
- Cover LDR with hand to see if value changes
- Use a multimeter to check voltage at GPIO34

### Issue: "No response from backend"

**Solutions:**
- Check API_BASE_URL is correct
- Verify backend is deployed and running
- Try ping the backend URL in browser
- Check firewall isn't blocking ESP32
- For local testing, use computer's IP address

---

## ğŸ“Š View Data on Dashboard

1. Go to https://synciot-frontend.vercel.app/dashboard
2. Login with your account
3. Click on your robot
4. You should see 3 sensors:
   - **Light Sensor** - Shows lux value
   - **Battery Monitor** - Shows battery percentage
   - **WiFi Signal** - Shows signal strength in dBm
5. Refresh the page to see updated values
6. Values update every 30 seconds

---

## ğŸ¯ Testing the LDR

1. **Cover the LDR** with your hand
   - Light value should decrease
   - Serial monitor shows "Dark" or "Dim"

2. **Shine a flashlight** on LDR
   - Light value should increase
   - Serial monitor shows "Bright" or "Very Bright"

3. **Normal room lighting**
   - Should show "Moderate" (around 40-60%)

4. **Check dashboard**
   - Refresh after 30 seconds
   - Light Sensor value should update

---

## âš™ï¸ Advanced Configuration

### Change Update Interval

In `config.h`:
```cpp
#define UPDATE_INTERVAL 30000  // 30 seconds

// For faster updates:
#define UPDATE_INTERVAL 10000  // 10 seconds

// For slower updates (save battery):
#define UPDATE_INTERVAL 60000  // 1 minute
```

### Calibrate LDR

Adjust these values based on your lighting conditions:

```cpp
// In config.h
#define LDR_MIN_VALUE 0      // Darkest (cover LDR, read raw value)
#define LDR_MAX_VALUE 4095   // Brightest (flashlight, read raw value)
```

### Add More Sensors

You can easily add more sensors by:
1. Adding sensor reading function in `sensors.h`
2. Reading the sensor in `readAndSendData()`
3. Adding to the JSON payload
4. Backend will auto-create the new sensor

---

## ğŸ”‹ Power Options

### USB Power (Development)
- Connect ESP32 via USB cable
- Simple, always powered
- For testing and development

### Battery Power (Deployment)
- 3.7V LiPo battery connected to ESP32
- Add battery voltage monitoring
- Can last days depending on update interval
- Add deep sleep for longer battery life

### Solar Power
- Small solar panel + LiPo battery
- For outdoor deployment
- ESP32 can run indefinitely

---

## ğŸ“ˆ Next Steps

1. âœ… Get basic setup working
2. âœ… Verify data appears in dashboard
3. Add more sensors (temperature, humidity, etc.)
4. Implement deep sleep for battery saving
5. Add real-time WebSocket updates
6. Add commands from dashboard to ESP32
7. Create mobile app
8. Build robot chassis

---

## ğŸ†˜ Need Help?

Check these resources:
- **ESP32 Documentation:** https://docs.espressif.com/projects/esp-idf/
- **Arduino JSON Library:** https://arduinojson.org/
- **Serial Monitor:** Shows all debug output
- **Backend Logs:** Check Vercel dashboard for errors
- **Frontend Console:** Open browser DevTools for errors

Happy building! ğŸ‰ğŸ¤–
